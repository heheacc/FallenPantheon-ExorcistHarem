<!DOCTYPE html>
<html lang="ko">
<head>
   <meta charset="UTF-8">
   <script src="https://cdn.tailwindcss.com"></script>
   <style>
      body {
         font-family: sans-serif;
         background: #0d0d0d;
         color: #eee;
         display: flex;
         justify-content: center;
         padding: 2rem;
      }

      .container {
         max-width: 1000px;
         width: 100%;
         background: #1a1a1a;
         padding: 2rem;
         border-radius: 8px;
         border: 1px solid #333;
      }

      .btn {
         width: 100%;
         padding: 10px;
         margin-top: 10px;
         background: #333;
         color: white;
         border: 1px solid #555;
         cursor: pointer;
      }

         .btn:hover {
            background: #444;
            border-color: #f55;
         }

      .btn-acc {
         background: #f55;
         color: #111;
         font-weight: bold;
      }

      .btn:disabled {
         opacity: 0.5;
         cursor: not-allowed;
      }

      .card {
         background: #282828;
         border: 2px solid transparent;
         cursor: pointer;
         position: relative;
         border-radius: 6px;
         overflow: hidden;
         transition: 0.2s;
      }

         .card.selected {
            border-color: #4bcffa;
         }

         .card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            filter: grayscale(1);
         }

         .card.selected img {
            filter: grayscale(0);
         }

      .card-text {
         position: absolute;
         bottom: 0;
         width: 100%;
         background: rgba(0,0,0,0.7);
         padding: 5px;
         text-align: center;
         font-size: 0.8rem;
      }

      .hidden {
         display: none;
      }

      .grid-4 {
         display: grid;
         grid-template-columns: repeat(4, 1fr);
         gap: 10px;
      }
   </style>
</head>
<body>

   <div class="container">
      <!-- Page 1 -->
      <div id="p1">
         <h1 class="text-3xl font-bold text-red-500 mb-4">퇴마 시뮬레이션</h1>
         <button class="btn btn-acc" onclick="go('p2')">시작하기 →</button>
      </div>

      <!-- Page 2: WI Toggle -->
      <div id="p2" class="hidden">
         <h2 class="text-xl font-bold mb-4">Step 1. 캐릭터 선택</h2>
         <div id="grid_wi" class="grid-4"></div>
         <button class="btn btn-acc" onclick="go('p3')">다음 →</button>
      </div>

      <!-- Page 3: Scenario -->
      <div id="p3" class="hidden">
         <h2 class="text-xl font-bold mb-4">Step 2. 시나리오</h2>
         <div class="flex gap-4">
            <div class="w-1/2">
               <h3>파트너 선택</h3>
               <div id="grid_partner" class="grid-4" style="grid-template-columns:repeat(2,1fr)"></div>
            </div>
            <div class="w-1/2">
               <h3>랜덤 시나리오</h3>
               <textarea id="rndIn" class="w-full bg-gray-800 p-2" rows="3"></textarea>
               <button id="btnRnd" class="btn">생성</button>
            </div>
         </div>
         <div id="preview" class="mt-4 p-4 bg-gray-800 hidden"></div>
         <button id="btnFinal" class="btn btn-acc" disabled onclick="go('p4')">최종 확인 →</button>
         <button class="btn" onclick="go('p2')">← 뒤로</button>
      </div>

      <!-- Page 4: Summary -->
      <div id="p4" class="hidden">
         <h2 class="text-xl font-bold mb-4">확인</h2>
         <div id="summary" class="bg-gray-800 p-4"></div>
         <button id="btnStart" class="btn btn-acc mt-4">시뮬레이션 시작</button>
         <button class="btn" onclick="go('p3')">← 수정</button>
      </div>
   </div>

   <script>
// 안전한 변수 선언
var chars = [
    {id:'priest', name:'신부', img:'https://placehold.co/100', isP:true, text:'신부 프롤로그'},
    {id:'shaman', name:'주술사', img:'https://placehold.co/100', isP:true, text:'주술사 프롤로그'},
    {id:'exorcist', name:'퇴마사', img:'https://placehold.co/100', isP:true, text:'퇴마사 프롤로그'},
    {id:'cultist', name:'숭배자', img:'https://placehold.co/100', isP:true, text:'숭배자 프롤로그'},
    {id:'michael', name:'미카엘', img:'https://placehold.co/100', isP:false},
    {id:'lucifer', name:'루시퍼', img:'https://placehold.co/100', isP:false}
];

var state = { wis: [], pid: null, scType: 'none', scText: '' };
var apiKey = ""; // 자동 주입

function go(id) {
    document.querySelectorAll('div[id^="p"]').forEach(d => d.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    if(id==='p2') renderWI();
    if(id==='p3') renderP();
    if(id==='p4') renderSum();
}

function renderWI() {
    var h = '';
    chars.forEach(c => {
        var s = state.wis.includes(c.id) ? 'selected' : '';
        h += `<div class="card ${s}" onclick="tWI('${c.id}', this)"><img src="${c.img}"><div class="card-text">${c.name}</div></div>`;
    });
    document.getElementById('grid_wi').innerHTML = h;
}

function tWI(id, el) {
    if(state.wis.includes(id)) { state.wis = state.wis.filter(x=>x!==id); el.classList.remove('selected'); }
    else { state.wis.push(id); el.classList.add('selected'); }
}

function renderP() {
    var h = '';
    chars.filter(c=>c.isP).forEach(c => {
        var s = (state.pid === c.id) ? 'selected' : '';
        h += `<div class="card ${s}" onclick="selP('${c.id}')"><img src="${c.img}"><div class="card-text">${c.name}</div></div>`;
    });
    document.getElementById('grid_partner').innerHTML = h;
}

function selP(id) {
    state.pid = id; state.scType='partner';
    state.scText = chars.find(c=>c.id===id).text;
    renderP(); check();
}

document.getElementById('btnRnd').onclick = async function() {
    this.innerText = "...";
    var q = document.getElementById('rndIn').value;
    try {
        var r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({contents:[{parts:[{text:"Scenario intro for: "+q}]}]})
        });
        var d = await r.json();
        state.scText = d.candidates[0].content.parts[0].text;
        state.scType = 'random'; state.pid = null;
        renderP(); check();
    } catch(e){alert('Error');}
    this.innerText = "생성";
};

function check() {
    var p = document.getElementById('preview');
    var b = document.getElementById('btnFinal');
    if(state.scType !== 'none') {
        p.innerText = state.scText; p.classList.remove('hidden');
        b.disabled = false;
    }
}

function renderSum() {
    document.getElementById('summary').innerHTML = `타입: ${state.scType}<br>WI: ${state.wis}<br><br>${state.scText}`;
}

document.getElementById('btnStart').onclick = function() {
    var cmd = `/run set_char ${state.pid||'default'}; /run set_wits ${state.wis}; /next_response ${state.scText}`;
    alert("명령어:\n"+cmd);
    go('p1');
};

go('p1');
   </script>
</body>
</html>