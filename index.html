<!DOCTYPE html>
<html lang="ko">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>í‡´ë§ˆ ì‹œë®¬ë ˆì´ì…˜: ì´ˆê¸°í™”ë©´ (Gothic Edition)</title>
   <!-- Tailwind CSS CDN -->
   <script src="https://cdn.tailwindcss.com"></script>
   <style>
      /* í°íŠ¸: ì œëª©ìš© EutmanGungseo ë° Playfair Display */
      @font-face {
         font-family: 'EutmanGungseo';
         src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2206-02@1.0/OKGUNG.woff2') format('woff2');
         font-weight: normal;
         font-display: swap;
      }

      @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap');

      :root {
         --color-bg: #0D0D1A;
         --color-surface: #1B1B2A;
         --color-primary: #DAA520; /* Goldenrod */
         --color-text: #E0E0E0;
         --color-accent: #4B0082; /* Deep Indigo */
      }

      body {
         font-family: 'Playfair Display', serif;
         background-color: var(--color-bg);
         color: var(--color-text);
         min-height: 100vh;
         display: flex;
         justify-content: center;
         align-items: center;
         padding: 2rem;
         text-align: center;
      }

      .main-container {
         width: 100%;
         max-width: 1024px;
         background-color: var(--color-surface);
         border: 2px solid var(--color-accent);
         border-radius: 8px;
         box-shadow: 0 0 30px rgba(0, 0, 0, 0.6);
         padding: 1.5rem 3rem 3rem 3rem;
         position: relative;
      }

      .header-title {
         font-family: 'EutmanGungseo', sans-serif;
         font-size: 3.5rem;
         font-weight: normal;
         letter-spacing: 0.15em;
         color: var(--color-primary);
         text-shadow: 0 0 15px rgba(218, 165, 32, 0.6);
         margin-top: 1rem;
      }

      .mono-button {
         padding: 0.75rem 2rem;
         border-radius: 4px;
         font-weight: 700;
         transition: all 0.3s;
         background-color: #333344;
         color: var(--color-text);
         border: 1px solid #555566;
         cursor: pointer;
      }

         .mono-button:hover {
            background-color: #444455;
            border-color: var(--color-primary);
            box-shadow: 0 0 10px rgba(218, 165, 32, 0.4);
         }

      .accent-button {
         background-color: var(--color-primary);
         color: var(--color-bg);
         border-color: var(--color-primary);
      }

         .accent-button:disabled {
            background-color: #555;
            color: #888;
            border-color: #555;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
         }

      .card {
         background: #28283a;
         border: 3px solid transparent;
         border-radius: 6px;
         overflow: hidden;
         cursor: pointer;
         transition: all 0.2s;
         position: relative;
      }

         .card:hover {
            border-color: #DAA520;
         }

      #grid_partner .card.selected {
         border-color: #4bcffa;
         box-shadow: 0 0 15px rgba(75, 207, 250, 0.7);
      }

      #grid_partner.one-selected .card:not(.selected) {
         opacity: 0.35;
      }

      .char-image {
         width: 100%;
         height: 270px;
         object-fit: cover;
         filter: grayscale(1) brightness(0.6);
         transition: filter 0.3s;
      }

      #grid_wi .char-image {
         height: 150px;
      }

      .card.selected .char-image {
         filter: grayscale(0) brightness(1);
      }

      .card-text {
         position: absolute;
         bottom: 0;
         width: 100%;
         background: rgba(0,0,0,0.7);
         padding: 5px;
         text-align: center;
         font-size: 0.8rem;
      }

      /* QTE ìŠ¤íƒ€ì¼ */
      #qte_popup {
         position: fixed;
         top: 0;
         left: 0;
         right: 0;
         bottom: 0;
         background-color: rgba(0, 0, 0, 0.9);
         display: flex;
         align-items: center;
         justify-content: center;
         z-index: 9999;
      }

         #qte_popup > div {
            background-color: var(--color-surface);
            border: 4px solid var(--color-primary);
            box-shadow: 0 0 25px rgba(218, 165, 32, 0.8);
         }

      #qte_input {
         font-family: monospace;
         border: 2px solid var(--color-primary);
      }

      .hidden {
         display: none !important;
      }

      .grid-4 {
         display: grid;
         grid-template-columns: repeat(4, 1fr);
         gap: 10px;
      }
   </style>
</head>
<body>

   <div class="main-container">

      <!-- [1. UI ìˆ˜ì •] ì–¸ì–´ ì„ íƒ ë“œë¡­ë‹¤ìš´ ìƒë‹¨ ë°°ì¹˜ -->
      <div class="flex justify-end mb-4 pt-2">
         <select id="langSelect" class="bg-gray-700 text-white p-2 rounded text-sm">
            <option value="ko">í•œêµ­ì–´ (Korean)</option>
            <option value="en">English (ì˜ì–´)</option>
         </select>
      </div>

      <!-- Page 1 -->
      <div id="p1" class="space-y-8">
         <h1 class="header-title" data-ko="í‡´ë§ˆ ì‹œë®¬ë ˆì´ì…˜: ê·¸ë¦¼ìì˜ ì¥" data-en="Exorcism Sim: Chapter of Shadows">
            í‡´ë§ˆ ì‹œë®¬ë ˆì´ì…˜: ê·¸ë¦¼ìì˜ ì¥
         </h1>
         <p data-ko="ì´ë‹¨ê³¼ ì‹ ì„±ì´ êµì°¨í•˜ëŠ” ì„¸ê³„ì—ì„œ, ë‹¹ì‹ ì˜ ì„ íƒì´ ìš´ëª…ì„ ê²°ì •í•©ë‹ˆë‹¤." data-en="In a world where heresy meets the divine, your choice determines destiny." class="text-xl text-gray-300 mb-6"></p>

         <div class="p-5 border border-gray-700 rounded-lg bg-black/30">
            <h2 data-ko="ì‹œë®¬ë ˆì´ì…˜ ê°€ì´ë“œ" data-en="Simulation Guide" class="text-2xl font-bold mb-3 text-yellow-400"></h2>
            <ul class="list-disc list-inside text-gray-400 space-y-2 text-left">
               <li data-ko="ì£¼ì œ: ì—‘ì†Œì‹œì¦˜/í‡´ë§ˆ ë‹¤í¬ íŒíƒ€ì§€ ë¡œë§¨ìŠ¤ ì‹œë®¬ë ˆì´ì…˜ì…ë‹ˆë‹¤." data-en="Theme: Exorcism/Dark Fantasy Romance Simulation."></li>
               <li data-ko="ì‹œìŠ¤í…œ: ì •í™”ë„, ì˜¤ì—¼ë„, í„´ì œ ì „íˆ¬, QTE íˆë“  ì´ë²¤íŠ¸ ë“± ì‹œìŠ¤í…œ ì¤‘ì‹¬ í”„ë¡¬í”„íŒ…ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤." data-en="System: Driven by system-centric prompting (Purity/Corruption, Turn-based Combat, QTE hidden events)."></li>
            </ul>
         </div>

         <div class="space-y-4">
            <button id="externalLinkBtn" class="mono-button" data-ko="ğŸ“˜ ì„¸ê³„ê´€ / ê·œì¹™ ë³´ê¸° (ì™¸ë¶€ë§í¬)" data-en="ğŸ“˜ View Lore / Rules (External Link)">
               ğŸ“˜ ì„¸ê³„ê´€ / ê·œì¹™ ë³´ê¸° (ì™¸ë¶€ë§í¬)
            </button>
            <button id="btn_p1_next" class="mono-button accent-button" onclick="go('p2')" data-ko="Step 1. ìºë¦­í„° WI ì„ íƒí•˜ê¸° â†’" data-en="Step 1. Select Character WI â†’">
               Step 1. ìºë¦­í„° WI ì„ íƒí•˜ê¸° â†’
            </button>
         </div>
      </div>

      <!-- Page 2: WI Toggle -->
      <div id="p2" class="hidden">
         <h2 class="text-3xl font-bold pb-3 border-b border-gray-600 text-yellow-400" data-ko="Step 1. ìºë¦­í„° WI í† ê¸€: í™œì„±í™”í•  ì¡°ë ¥ì/ì¡´ì¬ë¥¼ ì„ íƒí•˜ì„¸ìš”" data-en="Step 1. Character WI Toggle: Select Wits to Enable"></h2>

         <div class="p-4 mt-4 bg-[#28283a] border border-gray-700 rounded-lg">
            <p class="text-sm text-yellow-300 mb-4" data-ko="[ê°€ì´ë“œ] ì„ íƒí•œ ìºë¦­í„°ì˜ WIë§Œ STì˜ ì±„íŒ…ì— ì˜í–¥ì„ ì¤ë‹ˆë‹¤. íŒŒíŠ¸ë„ˆ ìºë¦­í„°ë¥¼ Chat Charë¡œ ì„¤ì •í•  ì˜ˆì •ì´ë¼ë©´ WIë¥¼ ë¯¸ë¦¬ ì¼œë‘ì„¸ìš”." data-en="[Guide] Only selected Wits will affect the chat. If you plan to set a Partner as the Chat Char, ensure their WI is enabled."></p>
            <!-- ìºë¦­í„° ê·¸ë¦¬ë“œ -->
            <div id="grid_wi" class="grid-4"></div>
         </div>

         <div class="flex gap-4 pt-6">
            <button class="mono-button" onclick="go('p1')" data-ko="â† ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°" data-en="â† Back to Start"></button>
            <button class="mono-button accent-button" onclick="go('p3')" data-ko="Step 2. ì‹œë‚˜ë¦¬ì˜¤ í™•ì •í•˜ê¸° â†’" data-en="Step 2. Confirm Scenario â†’">
               Step 2. ì‹œë‚˜ë¦¬ì˜¤ í™•ì •í•˜ê¸° â†’
            </button>
         </div>
      </div>

      <!-- Page 3: Scenario -->
      <div id="p3" class="hidden">
         <h2 class="text-3xl font-bold pb-3 border-b border-gray-600 text-yellow-400" data-ko="Step 2. ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ: ì´ì•¼ê¸°ì˜ ì‹œì‘ì ì„ ê²°ì •í•˜ì„¸ìš”" data-en="Step 2. Choose Scenario: Determine the starting point"></h2>

         <div class="flex flex-col md:flex-row gap-6 mt-4">
            <!-- íŒŒíŠ¸ë„ˆ ì„ íƒ -->
            <div class="md:w-1/2 p-4 bg-[#28283a] border border-gray-700 rounded-lg">
               <h3 class="text-xl font-bold text-yellow-300 mb-2" data-ko="â‘  íŒŒíŠ¸ë„ˆì™€ í•¨ê»˜ ì‹œì‘" data-en="â‘  Start with a Partner"></h3>
               <p class="text-gray-400 text-sm mb-4" data-ko="íŒŒíŠ¸ë„ˆì˜ í™•ì • í”„ë¡¤ë¡œê·¸ë¡œ ì‹œì‘í•˜ë©°, Chat Charê°€ ë©ë‹ˆë‹¤. ë‘ ë²ˆ í´ë¦­í•˜ë©´ ì„ íƒ í•´ì œë©ë‹ˆë‹¤." data-en="Starts with Partner's confirmed prologue as Chat Char. Double-click to deselect."></p>
               <div id="grid_partner" class="grid-4" style="grid-template-columns:repeat(2,1fr)"></div>
            </div>

            <!-- ëœë¤ ì‹œë‚˜ë¦¬ì˜¤ -->
            <div class="md:w-1/2 p-4 bg-[#28283a] border border-gray-700 rounded-lg">
               <h3 class="text-xl font-bold text-yellow-300 mb-2" data-ko="â‘¡ ëœë¤ ì‹œë‚˜ë¦¬ì˜¤ (ììœ  ì‹œì‘)" data-en="â‘¡ Random Scenario (Free Start)"></h3>
               <p class="text-gray-400 text-sm mb-4" data-ko="íŒŒíŠ¸ë„ˆ ì—†ì´ ììœ ë¡œìš´ ì„¤ì •ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤." data-en="Start freely without a designated Chat Partner."></p>
               <textarea id="rndIn" class="w-full bg-gray-800 p-2 text-gray-200" rows="3" data-ko-ph="ì˜ˆ: ë¯¸ì¹´ì—˜ê³¼ ë£¨ì‹œí¼ê°€ ë™ì‹œì— ë“±ì¥í•˜ëŠ” ë´‰ì¸ í•´ì œ ì‹œë‚˜ë¦¬ì˜¤." data-en-ph="Ex: A scenario where Michael and Lucifer appear simultaneously during a seal release."></textarea>
               <button id="btnRnd" class="btn mono-button" data-ko="ğŸ² ëœë¤ ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±" data-en="ğŸ² Generate Random Scenario">ìƒì„±</button>
            </div>
         </div>

         <!-- ë¯¸ë¦¬ë³´ê¸° -->
         <div id="preview" class="mt-4 p-4 bg-[#28283a] border border-gray-600 rounded-lg hidden">
            <h3 class="font-bold text-yellow-400 mb-2" data-ko="í”„ë¡¤ë¡œê·¸ ë¯¸ë¦¬ë³´ê¸°:" data-en="Prologue Preview:"></h3>
            <p id="previewText" class="text-sm italic text-gray-300"></p>
         </div>

         <div class="flex gap-4 pt-6">
            <button class="mono-button" onclick="go('p2')" data-ko="â† WI ì„ íƒ" data-en="â† Back to WI"></button>
            <button id="btnFinal" class="mono-button accent-button" disabled onclick="go('p4')" data-ko="ìµœì¢… í™•ì¸ â†’" data-en="Final Confirm â†’">
               ìµœì¢… í™•ì¸ â†’
            </button>
         </div>
      </div>

      <!-- Page 4: Summary -->
      <div id="p4" class="hidden">
         <h2 class="text-3xl font-bold text-yellow-400 mb-4" data-ko="ìµœì¢… ì„¤ì • í™•ì¸" data-en="Final Configuration"></h2>

         <div class="p-6 bg-[#28283a] border border-gray-600 rounded-lg text-left space-y-4">
            <p><strong><span data-key="summaryScenarioType">ì‹œì‘ ìœ í˜•:</span></strong> <span id="summary_type" class="text-yellow-300"></span></p>
            <p><strong><span data-key="summaryPartnerName">ë©”ì¸ Chat Char:</span></strong> <span id="summary_partner" class="text-yellow-300"></span></p>
            <p><strong><span data-key="summaryActiveWIs">í™œì„±í™”ëœ WI:</span></strong> <span id="summary_wis" class="text-blue-300 text-sm"></span></p>
            <div class="border-t border-gray-700 pt-4 mt-4">
               <p class="text-yellow-400 font-bold mb-2" data-key="summaryPrologueTitle">ì‹œì‘ í”„ë¡¤ë¡œê·¸:</p>
               <p id="summary_text" class="text-sm italic text-gray-400"></p>
            </div>
         </div>

         <div class="flex gap-4 pt-6">
            <button class="mono-button" onclick="go('p3')" data-ko="â† ìˆ˜ì •" data-en="â† Modify"></button>
            <button id="btnStart" class="mono-button accent-button" data-ko="â–¶ï¸ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘" data-en="â–¶ï¸ Start Simulation">
               â–¶ï¸ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
            </button>
         </div>
      </div>

      <!-- ============================================== -->
      <!-- Page 5: ì‹œë®¬ë ˆì´ì…˜ í”Œë ˆì´ UI (Game Status) -->
      <!-- ì´ ì½”ë“œë¥¼ Page 4 ë¸”ë¡ ë°”ë¡œ ë’¤ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš” -->
      <!-- ============================================== -->
      <div id="p5" class="hidden text-left space-y-6">
         <h2 class="text-3xl font-bold pb-3 border-b border-gray-600 text-yellow-400"
             data-ko="ì‹œë®¬ë ˆì´ì…˜ ìƒíƒœì°½" data-en="Simulation Status Dashboard"></h2>

         <!-- ìƒë‹¨ ì •ë³´ ê·¸ë¦¬ë“œ -->
         <div class="grid grid-cols-3 gap-4 text-sm font-sans">
            <!-- ë‚ ì§œ ë° ì‹œê°„ -->
            <div class="col-span-1 p-3 bg-black/40 rounded-lg border border-gray-700">
               <p class="font-bold text-yellow-500" data-ko="ë‚ ì§œ/ì‹œê°„" data-en="Date/Time"></p>
               <p id="game_date" class="text-white">Day 1</p>
            </div>
            <!-- í„´ ìƒíƒœ -->
            <div class="col-span-1 p-3 bg-black/40 rounded-lg border border-gray-700">
               <p class="font-bold text-yellow-500" data-ko="í„´ ìƒíƒœ" data-en="Turn Status"></p>
               <p id="turn_status" class="text-red-400 font-bold" data-ko="ëŒ€ê¸° ì¤‘" data-en="Awaiting Command"></p>
            </div>
            <!-- ì•„ì´í…œ/ì†Œëª¨í’ˆ -->
            <div class="col-span-1 p-3 bg-black/40 rounded-lg border border-gray-700">
               <p class="font-bold text-yellow-500" data-ko="ì•„ì´í…œ (ìŠ¬ë¡¯)" data-en="Inventory (Slots)"></p>
               <p id="item_slots" class="text-gray-300">3 / 5</p>
            </div>
         </div>

         <!-- ìƒíƒœ ë°” (HP, ì •í™”ë„, ì˜¤ì—¼ë„) -->
         <div class="space-y-4">
            <!-- HP -->
            <div>
               <div class="flex justify-between font-bold">
                  <span data-ko="HP" data-en="Health (HP)">HP</span>
                  <span id="hp_value">100 / 100</span>
               </div>
               <div class="w-full bg-gray-700 h-3 rounded-full overflow-hidden">
                  <div id="hp_bar" class="bg-red-500 h-full transition-all duration-500" style="width: 100%;"></div>
               </div>
            </div>

            <!-- ì •í™”ë„ (Purity) -->
            <div>
               <div class="flex justify-between font-bold">
                  <span data-ko="ì •í™”ë„" data-en="Purity">ì •í™”ë„</span>
                  <span id="purity_value">50 / 100</span>
               </div>
               <div class="w-full bg-gray-700 h-3 rounded-full overflow-hidden">
                  <div id="purity_bar" class="bg-blue-400 h-full transition-all duration-500" style="width: 50%;"></div>
               </div>
            </div>

            <!-- ì˜¤ì—¼ë„ (Contamination) -->
            <div>
               <div class="flex justify-between font-bold">
                  <span data-ko="ì˜¤ì—¼ë„" data-en="Contamination">ì˜¤ì—¼ë„</span>
                  <span id="contam_value">0 / 100</span>
               </div>
               <div class="w-full bg-gray-700 h-3 rounded-full overflow-hidden">
                  <div id="contam_bar" class="bg-purple-600 h-full transition-all duration-500" style="width: 0%;"></div>
               </div>
            </div>
         </div>

         <!-- QTE íŒì—… ì»¨í…Œì´ë„ˆ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
         <div id="qte_popup" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
            <div class="bg-gray-900 p-8 rounded-lg border-4 border-yellow-500 text-center space-y-4 max-w-lg w-full">
               <h3 id="qte_title" class="text-3xl font-bold text-yellow-500 font-display" data-ko="ê¸´ê¸‰ QTE ë°œë™!" data-en="Emergency QTE Triggered!"></h3>
               <p id="qte_prompt" class="text-xl text-yellow-300 font-mono"></p>

               <!-- íƒ€ì´í•‘ ì…ë ¥ì°½ -->
               <input type="text" id="qte_input" class="w-full p-3 bg-gray-700 text-white rounded text-center text-lg font-mono placeholder-gray-400"
                      data-ko-ph="ì—¬ê¸°ì— êµ¬ì ˆì„ ë¹ ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”..." data-en-ph="Type the holy verse quickly here..." autofocus>

               <!-- íƒ€ì´ë¨¸ ë° ê²°ê³¼ í”¼ë“œë°± -->
               <p id="qte_timer" class="text-lg text-white font-bold"></p>
               <div id="qte_feedback" class="text-xl font-bold mt-2"></div>
            </div>
         </div>

         <!-- ì„ì‹œ ë²„íŠ¼: STë¡œ ëŒì•„ê°€ê¸° (ì•ˆë‚´ìš©) -->
         <div class="pt-6 border-t border-gray-700">
            <button onclick="alert('ST ì±„íŒ…ì°½ì—ì„œ ëŒ€í™”ë¥¼ ì´ì–´ê°€ì„¸ìš”. UIëŠ” ì—´ì–´ë‘ì…”ë„ ë©ë‹ˆë‹¤.')" class="mono-button accent-button w-full" data-ko="ëŒ€í™”ë¡œ ëŒì•„ê°€ê¸° (ì°½ ìœ ì§€)" data-en="Return to Chat (Keep Open)">ëŒ€í™”ë¡œ ëŒì•„ê°€ê¸° (ì°½ ìœ ì§€)</button>
         </div>
      </div>

<script>
// --- ì „ì—­ ë°ì´í„° ë° ìƒíƒœ ---
var chars = [
    {id:'priest', name:'ìš”í•œ ì‹ ë¶€', type:'ì‚¬ì œ', isP:true, img:'https://placehold.co/180x270/1a1a1a/e0e0e0?text=Priest', text:'ì–´ë‘  ì†ì—ì„œ ì†ì£„ë¥¼ êµ¬í•˜ëŠ” í•œ ë‚¨ìì˜ ì´ì•¼ê¸°. ê³ ëŒ€ ìœ ë¬¼ì˜ ì €ì£¼ë¥¼ í’€ê¸° ìœ„í•´ íí—ˆê°€ ëœ ìˆ˜ë„ì›ìœ¼ë¡œ í–¥í•˜ë©° ë‹¹ì‹ ê³¼ì˜ ë§Œë‚¨ì´ ì‹œì‘ëœë‹¤.'},
    {id:'shaman', name:'ìƒ¤ì¹´ ì£¼ìˆ ì‚¬', type:'ì£¼ìˆ ì‚¬', isP:true, img:'https://placehold.co/180x270/1a1a1a/e0e0e0?text=Shaman', text:'ì‹ ì„±í•œ ë¶ˆê½ƒìœ¼ë¡œ ì•…ì„ ë©¸í•˜ëŠ” ì£¼ìˆ ì‚¬. ë¯¸ì§€ì˜ ì „ì—¼ë³‘ì— ê±¸ë¦° ë§ˆì„ì„ êµ¬í•˜ê¸° ìœ„í•œ ì—¬ì •ì—ì„œ, ë‹¹ì‹ ì€ ê·¸ì˜ ê°•ë ¥í•œ ì¡°ë ¥ìê°€ ëœë‹¤.'},
    {id:'exorcist', name:'í˜„ëŒ€ í‡´ë§ˆì‚¬', type:'í‡´ë§ˆì‚¬', isP:true, img:'https://placehold.co/180x270/1a1a1a/e0e0e0?text=Exorcist', text:'ë¹ ë¥¸ íŒë‹¨ë ¥ê³¼ í˜„ëŒ€ ê¸°ìˆ ì„ ì‚¬ìš©í•˜ëŠ” ëƒ‰ì² í•œ í‡´ë§ˆì‚¬. ë„ì‹œì˜ ëœë“œë§ˆí¬ì—ì„œ ë°œìƒí•˜ëŠ” ì—°ì‡„ ì‹¤ì¢… ì‚¬ê±´ì„ í•´ê²°í•˜ê¸° ìœ„í•´ ë‹¹ì‹ ê³¼ íŒŒíŠ¸ë„ˆë¥¼ ë§ºëŠ”ë‹¤.'},
    {id:'cultist', name:'ì•„ë§ˆì¶”ì–´', type:'ìˆ­ë°°ì', isP:true, img:'https://placehold.co/180x270/1a1a1a/e0e0e0?text=Cultist', text:'ì•…ë§ˆë¥¼ ì†Œí™˜í•˜ë ¤ë‹¤ ì‹¤ìˆ˜ë¡œ ë‹¹ì‹ ì„ ë§Œë‚œ ì•„ë§ˆì¶”ì–´ ìˆ­ë°°ì. ìˆ˜ìŠµ ë¶ˆê°€ëŠ¥í•œ ì˜ì  ì‚¬íƒœë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ë‹¹ì‹ ì—ê²Œ ë§¤ë‹¬ë¦¬ëŠ” ì–´ì„¤í”ˆ íŒŒíŠ¸ë„ˆ.'},

    // ë¹„ì¸ê°„ê³„
    {id:'michael', name:'ë¯¸ì¹´ì—˜', type:'ì²œì‚¬', isP:false, img:'https://placehold.co/150x225/11112d/DAA520?text=Mikael'},
    {id:'uriel', name:'ìš°ë¦¬ì—˜', type:'ì²œì‚¬', isP:false, img:'https://placehold.co/150x225/11112d/DAA520?text=Uriel'},
    {id:'lucifer', name:'ë£¨ì‹œí¼', type:'íƒ€ì²œì‚¬', isP:false, img:'https://placehold.co/150x225/2d1111/DAA520?text=Lucifer'},
    {id:'mephisto', name:'ë©”í”¼ìŠ¤í† ', type:'ì•…ë§ˆ', isP:false, img:'https://placehold.co/150x225/2d1111/DAA520?text=Mephisto'},
    {id:'astaroth', name:'ì•„ìŠ¤íƒ€ë¡œíŠ¸', type:'ì•…ë§ˆ', isP:false, img:'https://placehold.co/150x225/2d1111/DAA520?text=Astaroth'},
    {id:'vishnu', name:'ë¹„ìŠˆëˆ„', type:'íŒë‘ì‹ ', isP:false, img:'https://placehold.co/150x225/112d11/DAA520?text=Vishnu'},
    {id:'agni', name:'ì•„ê·¸ë‹ˆ', type:'íŒë‘ì‹ ', isP:false, img:'https://placehold.co/150x225/112d11/DAA520?text=Agni'},
    {id:'chouno', name:'ì²œí˜¸', type:'ë™ì–‘ì˜ë¬¼', isP:false, img:'https://placehold.co/150x225/2d2d11/DAA520?text=Chouno'},
    {id:'kirin', name:'ê¸°ë¦°', type:'í™˜ìˆ˜', isP:false, img:'https://placehold.co/150x225/2d2d11/DAA520?text=Kirin'},
];

var state = { wis: [], pid: null, scType: 'none', scText: '', currentPage: 'p1' };
var currentLang = 'ko';

// ê²Œì„ ìƒíƒœ ë³€ìˆ˜
var gameState = {
    hp: 100, maxHp: 100,
    purity: 50, maxPurity: 100,
    contam: 0, maxContam: 100,
    day: 1, time: 'Day',
    turnActive: false,
    inventory: 3, maxInventory: 5,
    qteActive: false,
};
var inventoryItems = ['holy_water', 'blessed_amulet', 'salt_gun'];

var apiKey = "";
var apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=" + apiKey;

// --- ë‹¤êµ­ì–´ ë²ˆì—­ ë°ì´í„° (ì´ì „ê³¼ ë™ì¼) ---
var translations = {
    ko: {
        'headerTitle': 'í‡´ë§ˆ ì‹œë®¬ë ˆì´ì…˜: ê·¸ë¦¼ìì˜ ì¥', 'subTitle': 'ì´ë‹¨ê³¼ ì‹ ì„±ì´ êµì°¨í•˜ëŠ” ì„¸ê³„ì—ì„œ, ë‹¹ì‹ ì˜ ì„ íƒì´ ìš´ëª…ì„ ê²°ì •í•©ë‹ˆë‹¤.', 'guideTitle': 'ì‹œë®¬ë ˆì´ì…˜ ê°€ì´ë“œ', 'guideTheme': 'ì£¼ì œ: ì—‘ì†Œì‹œì¦˜/í‡´ë§ˆ ë‹¤í¬ íŒíƒ€ì§€ ë¡œë§¨ìŠ¤ ì‹œë®¬ë ˆì´ì…˜ì…ë‹ˆë‹¤.', 'guideSystem': 'ì‹œìŠ¤í…œ: ì •í™”ë„, ì˜¤ì—¼ë„, í„´ì œ ì „íˆ¬, QTE íˆë“  ì´ë²¤íŠ¸ ë“± ì‹œìŠ¤í…œ ì¤‘ì‹¬ í”„ë¡¬í”„íŒ…ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.', 'btn_p1_next': 'Step 1. ìºë¦­í„° WI ì„ íƒí•˜ê¸° â†’', 'step1Title': 'Step 1. ìºë¦­í„° WI í† ê¸€: í™œì„±í™”í•  ì¡°ë ¥ì/ì¡´ì¬ë¥¼ ì„ íƒí•˜ì„¸ìš”', 'guideToggle': '[ê°€ì´ë“œ] ì„ íƒí•œ ìºë¦­í„°ì˜ WIë§Œ STì˜ ì±„íŒ…ì— ì˜í–¥ì„ ì¤ë‹ˆë‹¤. íŒŒíŠ¸ë„ˆ ìºë¦­í„°ë¥¼ Chat Charë¡œ ì„¤ì •í•  ì˜ˆì •ì´ë¼ë©´ WIë¥¼ ë¯¸ë¦¬ ì¼œë‘ì„¸ìš”.', 'step2Title': 'Step 2. ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ: ì´ì•¼ê¸°ì˜ ì‹œì‘ì ì„ ê²°ì •í•˜ì„¸ìš”', 'partnerTitle': 'â‘  íŒŒíŠ¸ë„ˆì™€ í•¨ê»˜ ì‹œì‘', 'partnerDesc': 'íŒŒíŠ¸ë„ˆì˜ í™•ì • í”„ë¡¤ë¡œê·¸ë¡œ ì‹œì‘í•˜ë©°, Chat Charê°€ ë©ë‹ˆë‹¤. ë‘ ë²ˆ í´ë¦­í•˜ë©´ ì„ íƒ í•´ì œë©ë‹ˆë‹¤.', 'randomTitle': 'â‘¡ ëœë¤ ì‹œë‚˜ë¦¬ì˜¤ (ììœ  ì‹œì‘)', 'randomDesc': 'íŒŒíŠ¸ë„ˆ ì—†ì´ ììœ ë¡œìš´ ì„¤ì •ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.', 'rndPh': 'ì˜ˆ: ë¯¸ì¹´ì—˜ê³¼ ë£¨ì‹œí¼ê°€ ë™ì‹œì— ë“±ì¥í•˜ëŠ” ë´‰ì¸ í•´ì œ ì‹œë‚˜ë¦¬ì˜¤.', 'btnRnd': 'ğŸ² ëœë¤ ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±', 'previewTitle': 'í”„ë¡¤ë¡œê·¸ ë¯¸ë¦¬ë³´ê¸°:', 'btnBackStart': 'â† ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°', 'btnBackWI': 'â† WI ì„ íƒ', 'btnFinal': 'ìµœì¢… í™•ì¸ â†’', 'step4Title': 'ìµœì¢… ì„¤ì • í™•ì¸', 'summaryScenarioType': 'ì‹œì‘ ìœ í˜•:', 'summaryPartnerName': 'ë©”ì¸ Chat Char:', 'summaryActiveWIs': 'í™œì„±í™”ëœ WI:', 'summaryPrologueTitle': 'ì‹œì‘ í”„ë¡¤ë¡œê·¸:', 'btnModify': 'â† ìˆ˜ì •', 'btnStart': 'â–¶ï¸ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘'
    },
    en: {
        'headerTitle': 'Exorcism Sim: Chapter of Shadows', 'subTitle': 'In a world where heresy meets the divine, your choice determines destiny.', 'guideTitle': 'Simulation Guide', 'guideTheme': 'Theme: Exorcism/Dark Fantasy Romance Simulation.', 'guideSystem': 'System: Driven by system-centric prompting (Purity/Corruption, Turn-based Combat, QTE hidden events).', 'btn_p1_next': 'Step 1. Select Character WI â†’', 'step1Title': 'Step 1. Character WI Toggle: Select Wits to Enable', 'guideToggle': '[Guide] Only selected Wits will affect the chat. If you plan to set a Partner as the Chat Char, ensure their WI is enabled.', 'step2Title': 'Step 2. Choose Scenario: Determine the starting point', 'partnerTitle': 'â‘  Start with a Partner', 'partnerDesc': 'Starts with Partner\'s confirmed prologue as Chat Char. Double-click to deselect.', 'randomTitle': 'â‘¡ Random Scenario (Free Start)', 'randomDesc': 'Start freely without a designated Chat Partner.', 'rndPh': 'Ex: A scenario where Michael and Lucifer appear simultaneously during a seal release.', 'btnRnd': 'ğŸ² Generate Random Scenario', 'previewTitle': 'Prologue Preview:', 'btnBackStart': 'â† Back to Start', 'btnBackWI': 'â† Back to WI', 'btnFinal': 'Final Confirm â†’', 'step4Title': 'Final Configuration', 'summaryScenarioType': 'Scenario Type:', 'summaryPartnerName': 'Main Chat Char:', 'summaryActiveWIs': 'Active Wits:', 'summaryPrologueTitle': 'Starting Prologue:', 'btnModify': 'â† Modify', 'btnStart': 'â–¶ï¸ Start Simulation'
    }
};


// --- ê¸°ëŠ¥ ë¡œì§ ---

// [NEW] í•¨ìˆ˜ë¥¼ Window ê°ì²´ì— ë…¸ì¶œ (LaLib ì—°ë™ìš©)
window.go = go;
window.tWI = tWI;
window.selP = selP;
window.generateRandomScenario = generateRandomScenario;
window.updateGameStatus = updateGameStatus;
window.updateDateTime = updateDateTime;
window.toggleTurnSystem = toggleTurnSystem;
window.handleQTE = handleQTE;


function go(id) {
    document.querySelectorAll('div[id^="p"]').forEach(function(d) { d.classList.add('hidden'); });
    document.getElementById(id).classList.remove('hidden');

    state.currentPage = id;
    updateLang(currentLang);

    if (id === 'p2') renderWI();
    if (id === 'p3') {
        renderP();
        updateScenarioPreview(state.scType);
    }
    if (id === 'p4') renderSum();
    if (id === 'p5') updateInventoryUI();
}

function updateLang(lang) {
    var dict = translations[lang];
    if (!dict) return;

    document.querySelectorAll('[data-ko], [data-en]').forEach(function(el) {
        var key = el.getAttribute('data-' + lang);
        if (key) { el.innerText = key; }
    });

    var rndInput = document.getElementById('rndIn');
    if (rndInput) {
        var phKey = (lang === 'ko') ? rndInput.getAttribute('data-ko-ph') : rndInput.getAttribute('data-en-ph');
        if (phKey) { rndInput.placeholder = phKey; }
    }

    if (state.currentPage === 'p3') {
        updateScenarioPreview(state.scType);
    }
}

function renderWI() {
    var grid = document.getElementById('grid_wi');
    var html = "";

    chars.forEach(function(c) {
        var isSelected = state.wis.includes(c.id) ? 'selected' : '';
        var textColor = c.isP ? 'text-yellow-400' : 'text-blue-400';

        html += '<div class="card ' + isSelected + '" onclick="tWI(\'' + c.id + '\', this)">' +
                '<img src="' + c.img + '" class="char-image">' +
                '<div class="card-text">' +
                '<span class="block font-bold text-white">' + c.name + '</span>' +
                '<span class="block text-xs ' + textColor + '">' + c.type + '</span>' +
                '</div></div>';
    });
    grid.innerHTML = html;
}

function tWI(id, el) {
    if (state.wis.includes(id)) { state.wis = state.wis.filter(function(x) { return x !== id; }); el.classList.remove('selected'); }
    else { state.wis.push(id); el.classList.add('selected'); }
}

function renderP() {
    var grid = document.getElementById('grid_partner');
    var html = "";

    var partners = chars.filter(function(c) { return c.isP; });
    partners.forEach(function(c) {
        var isSelected = (state.pid === c.id) ? 'selected' : '';
        html += '<div class="card ' + isSelected + '" onclick="selP(\'' + c.id + '\')">' +
                '<img src="' + c.img + '" class="char-image">' +
                '<div class="card-text"><span class="font-bold text-white">' + c.name + '</span></div>' +
                '</div>';
    });
    grid.innerHTML = html;

    if (state.pid) { grid.classList.add('one-selected'); } else { grid.classList.remove('one-selected'); }
}

function selP(id) {
    var partner = chars.find(function(c) { return c.id === id; });

    if (state.pid === id) {
        state.wis = state.wis.filter(function(x) { return x !== id; });
        state.pid = null;
        state.scType = 'none';
        state.scText = '';
    } else {
        state.pid = id;
        state.scType = 'partner';
        state.scText = partner.text;

        if (!state.wis.includes(id)) {
            state.wis.push(id);
        }
    }

    renderP();
    updateScenarioPreview(state.scType);
}

function updateScenarioPreview(type) {
    var previewDiv = document.getElementById('preview');
    var textP = document.getElementById('previewText');
    var nextBtn = document.getElementById('btnFinal');

    var msg = (currentLang === 'ko') ? "íŒŒíŠ¸ë„ˆë¥¼ ì„ íƒí•˜ê±°ë‚˜ ëœë¤ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìƒì„±í•´ ì£¼ì„¸ìš”." : "Select a partner or generate a random scenario.";

    if (state.scType !== 'none' && state.scText) {
        nextBtn.disabled = false;
        nextBtn.innerText = (currentLang === 'ko' ? "ìµœì¢… í™•ì¸ â†’" : "Final Confirm â†’");
        previewDiv.classList.remove('hidden');
        msg = state.scText;
    } else {
        nextBtn.disabled = true;
        nextBtn.innerText = (currentLang === 'ko' ? "ì„ íƒ í•„ìš”" : "Selection Required");
        previewDiv.classList.add('hidden');
    }

    textP.innerText = msg;
}

async function generateRandomScenario() {
    var btn = document.getElementById('btnRnd');
    var input = document.getElementById('rndIn').value;

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner mr-2"></span> ' + (currentLang === 'ko' ? 'ìƒì„± ì¤‘...' : 'Generating...');

    state.pid = null;
    renderP();

    var activeCharNames = chars.filter(function(c) { return state.wis.includes(c.id); }).map(function(c) { return c.name; });
    var charPrompt = "";

    if (activeCharNames.length > 0) {
        charPrompt = (currentLang === 'ko' ?
            `í˜„ì¬ WIê°€ í™œì„±í™”ëœ ìºë¦­í„° ëª©ë¡ì€ [${activeCharNames.join(', ')}] ì…ë‹ˆë‹¤. ì´ ì¤‘ 1~3ëª…ì˜ ìºë¦­í„°ë¥¼ ì‹œë‚˜ë¦¬ì˜¤ì— í¬í•¨í•´ì£¼ì„¸ìš”.` :
            `The following characters have active Wits: [${activeCharNames.join(', ')}]. Please integrate 1 to 3 of them into the scenario.`);
    } else {
         charPrompt = (currentLang === 'ko' ?
            `í˜„ì¬ í™œì„±í™”ëœ WI ìºë¦­í„°ëŠ” ì—†ìŠµë‹ˆë‹¤. ì‹œë‚˜ë¦¬ì˜¤ëŠ” ì™„ì „íˆ ììœ ë¡œìš´ ì£¼ì œë¡œ ìƒì„±í•´ì£¼ì„¸ìš”.` :
            `No Wits are currently active. Generate a scenario on a completely free topic.`);
    }

    var userQuery = (currentLang === 'ko' ?
        `Gothic horror í‡´ë§ˆ ì„ë¬´ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ 2-3 ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”. ì‚¬ìš©ì ìš”ì²­: ${input}. ${charPrompt}` :
        `Generate a 2-3 sentence gothic horror exorcism mission scenario. User request: ${input}. ${charPrompt}`);

    try {
        var response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: "Act as a dark fantasy RPG master. Respond only with the scenario text in the language requested by the user." }] }
            })
        });

        var data = await response.json();
        var generatedText = data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts[0].text ? data.candidates[0].content.parts[0].text.trim() : null;

        if (generatedText) {
            state.scText = generatedText;
            state.scType = 'random';
        } else {
            throw new Error("Empty response");
        }

    } catch (e) {
        console.error("API Call Error:", e);
        var errMsg = (currentLang === 'ko') ? "API ì—°ê²° ì˜¤ë¥˜ì…ë‹ˆë‹¤. STì— í‚¤ê°€ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”." : "API connection error. Check if your API key is set in ST.";
        alert(errMsg);
        state.scText = errMsg;
        state.scType = 'none';
    }

    btn.disabled = false;
    btn.innerHTML = (currentLang === 'ko') ? 'ğŸ² ëœë¤ ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±' : 'ğŸ² Generate Random Scenario';
    updateScenarioPreview(state.scType);
}

function renderSum() {
    var p = chars.find(function(c) { return c.id === state.pid; });
    var pName = p ? p.name : (currentLang === 'ko' ? "ì—†ìŒ (ììœ  ì‹œì‘)" : "None (Free Start)");

    var sType = (state.scType === 'random') ? (currentLang === 'ko' ? "ëœë¤" : "Random") : (currentLang === 'ko' ? "íŒŒíŠ¸ë„ˆ í™•ì •" : "Partner Confirmed");

    document.getElementById('summary_type').innerText = sType;
    document.getElementById('summary_partner').innerText = pName;
    document.getElementById('summary_wis').innerText = state.wis.length + (currentLang === 'ko' ? "ëª… í™œì„±í™”: " : " active: ") + state.wis.join(', ');
    document.getElementById('summary_text').innerText = state.scText;
}

document.getElementById('btnStart').onclick = function() {
    var partnerId = state.pid || 'default';
    var finalWIs = state.wis.slice();

    var wits = finalWIs.filter(function(id) { return id !== partnerId; }).join(',');
    var text = document.getElementById('summary_text').innerText;

    var initialPrompt = (currentLang === 'ko' ?
        `[SIM START - Main Target: ${partnerId}] ë‹¹ì‹ ì˜ ì„ë¬´ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. í˜„ì¬ ì‹œë‚˜ë¦¬ì˜¤: "${text}". ì´ ìŠ¤í¬ë¦½íŠ¸ì— ì´ì–´ì„œ ì²« ëŒ€ì‚¬ë¥¼ ì‹œì‘í•˜ì„¸ìš”. [OPEN_UI: Exorcism_Gothic_I18n_Game_UI_Final.html] ì•ìœ¼ë¡œ ì‹œìŠ¤í…œ ê¸°ë°˜ í”„ë¡¬í”„íŒ…ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤. (í™œì„± WI: ${wits})` :
        `[SIM START - Main Target: ${partnerId}] Your mission begins. Scenario: "${text}". Continue with the first response. [OPEN_UI: Exorcism_Gothic_I18n_Game_UI_Final.html] The session will now proceed with system-based prompting. (Active WIs: ${wits})`);

    // ST ëª…ë ¹: set_char, set_witsë¥¼ ì§ì ‘ ì…ë ¥í•˜ë„ë¡ ì•ˆë‚´

    alert((currentLang === 'ko' ? "ì‹œë®¬ë ˆì´ì…˜ ì„¤ì •ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ST ì±„íŒ…ì°½ìœ¼ë¡œ ëŒì•„ê°€ì„œ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì²« ë©”ì‹œì§€ë¡œ ì…ë ¥í•˜ì„¸ìš”:" : "Configuration complete. Return to the ST chat and enter the following commands as your first message:") +
          `\n\n/set_char ${partnerId}\n/set_wits ${wits}\n\n` +
          (currentLang === 'ko' ? "ê·¸ë¦¬ê³  ë‹¤ìŒ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”:" : "Then send this message to start the conversation:") +
          `\n\n${initialPrompt}`);

    go('p1');
    state = { wis: [], pid: null, scType: 'none', scText: '', currentPage: 'p1' };
};


// [NEW] ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸ ë¡œì§ (HP, ì •í™”ë„, ì˜¤ì—¼ë„)
function updateGameStatus(type, value) {
    value = parseInt(value);
    if (isNaN(value)) return;

    var barId, valueId, maxVal;

    if (type === 'hp') {
        gameState.hp = Math.min(gameState.maxHp, Math.max(0, gameState.hp + value));
        barId = 'hp_bar'; valueId = 'hp_value'; maxVal = gameState.maxHp;
    } else if (type === 'purity') {
        gameState.purity = Math.min(gameState.maxPurity, Math.max(0, gameState.purity + value));
        barId = 'purity_bar'; valueId = 'purity_value'; maxVal = gameState.maxPurity;
    } else if (type === 'contam') {
        gameState.contam = Math.min(gameState.maxContam, Math.max(0, gameState.contam + value));
        barId = 'contam_bar'; valueId = 'contam_value'; maxVal = gameState.maxContam;
    } else {
        return;
    }

    var percentage = (gameState[type] / maxVal) * 100;
    document.getElementById(barId).style.width = percentage + '%';
    document.getElementById(valueId).innerText = gameState[type] + ' / ' + maxVal;

    if (gameState.hp <= 0 || gameState.contam >= 100) {
        toggleTurnSystem('END');
        alert((currentLang === 'ko' ? "ì‹œë®¬ë ˆì´ì…˜ ì¢…ë£Œ: HP ê³ ê°ˆ ë˜ëŠ” ì˜¤ì—¼ë„ í•œê³„" : "Simulation Ended: HP Depletion or Contamination Limit"));
    }
}

// [NEW] ë‚ ì§œ ë° ì‹œê°„ ì—…ë°ì´íŠ¸
function updateDateTime(days, time) {
    gameState.day = parseInt(days);
    gameState.time = time;
    document.getElementById('game_date').innerText = `Day ${gameState.day}, ${gameState.time}`;
}

// [NEW] í„´ì œ ì‹œìŠ¤í…œ í™œì„±í™”/ë¹„í™œì„±í™”
function toggleTurnSystem(activeStatus) {
    var statusEl = document.getElementById('turn_status');
    var isActive = activeStatus === 'START';
    gameState.turnActive = isActive;

    if (isActive) {
        statusEl.innerText = (currentLang === 'ko' ? "í„´ í™œì„±í™”: ë‹¹ì‹ ì˜ í„´" : "Turn Active: Your Turn");
        statusEl.classList.remove('text-red-400');
        statusEl.classList.add('text-green-400');
    } else {
        statusEl.innerText = (currentLang === 'ko' ? "ëŒ€ê¸° ì¤‘" : "Awaiting Command");
        statusEl.classList.remove('text-green-400');
        statusEl.classList.add('text-red-400');
    }
}

// [NEW] ì¸ë²¤í† ë¦¬ UI ì—…ë°ì´íŠ¸
function updateInventoryUI() {
    gameState.inventory = inventoryItems.length;
    document.getElementById('item_slots').innerText = `${gameState.inventory} / ${gameState.maxInventory}`;
}

// [NEW] QTE ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (ë¡œì§ ì™„ì„±)
function handleQTE(type, prompt) {
    if (gameState.qteActive) return;
    gameState.qteActive = true;

    var popup = document.getElementById('qte_popup');
    var inputEl = document.getElementById('qte_input');
    var timerEl = document.getElementById('qte_timer');
    var feedbackEl = document.getElementById('qte_feedback');

    var timeLimit = 5;
    var timer;

    popup.classList.remove('hidden');
    inputEl.classList.remove('hidden');
    inputEl.value = '';
    inputEl.focus();
    feedbackEl.innerText = '';

    document.getElementById('qte_prompt').innerText = prompt;
    document.getElementById('qte_title').innerText = (currentLang === 'ko' ? "ê¸´ê¸‰ QTE ë°œë™!" : "Emergency QTE Triggered!");

    var finishQTE = function(isSuccess) {
        clearInterval(timer);
        gameState.qteActive = false;

        var resultCmd = isSuccess ? 'SUCCESS' : 'FAILURE';
        var resultText = isSuccess ? (currentLang === 'ko' ? "ì„±ê³µ! í”¼í•´ë¥¼ ë°©ì–´í–ˆìŠµë‹ˆë‹¤." : "SUCCESS! Damage avoided.") : (currentLang === 'ko' ? "ì‹¤íŒ¨! ì¶©ê²©ì´ ì˜µë‹ˆë‹¤." : "FAILURE! You take damage.");

        feedbackEl.innerText = resultText;
        feedbackEl.classList.remove('text-green-500', 'text-red-500');
        feedbackEl.classList.add(isSuccess ? 'text-green-500' : 'text-red-500');

        var cmd = `/next_response [QTE_RESULT: ${resultCmd}] ${isSuccess ? 'QTE ì„±ê³µìœ¼ë¡œ ìœ„ê¸°ë¥¼ ê·¹ë³µí–ˆìŠµë‹ˆë‹¤.' : 'QTE ì‹¤íŒ¨ë¡œ ì¹˜ëª…ì ì¸ ê³µê²©ì„ ë°›ì•˜ìŠµë‹ˆë‹¤.'}`;

        setTimeout(function() {
            popup.classList.add('hidden');
        }, 2000);

        // QTE ê²°ê³¼ëŠ” ST ì±„íŒ…ìœ¼ë¡œ ì§ì ‘ ì „ì†¡í•˜ë„ë¡ ì•ˆë‚´
        alert((currentLang === 'ko' ? "QTE ì™„ë£Œ. ST ì±„íŒ…ì°½ìœ¼ë¡œ ëŒì•„ê°€ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì—¬ ëŒ€í™”ë¥¼ ì´ì–´ê°€ì„¸ìš”." : "QTE Complete. Return to ST chat and enter the command below to continue.") + `\n\n${cmd}`);
    };

    // --- íƒ€ì´ë¨¸ ì‹œì‘ ---
    var timeLeft = timeLimit;
    timerEl.innerText = (currentLang === 'ko' ? `ë‚¨ì€ ì‹œê°„: ${timeLeft}ì´ˆ` : `Time Left: ${timeLeft}s`);

    timer = setInterval(function() {
        timeLeft--;
        timerEl.innerText = (currentLang === 'ko' ? `ë‚¨ì€ ì‹œê°„: ${timeLeft}ì´ˆ` : `Time Left: ${timeLeft}s`);

        if (timeLeft <= 0) {
            clearInterval(timer);
            finishQTE(false);
        }
    }, 1000);

    // --- QTE íƒ€ì…ë³„ ë¡œì§ ---
    if (type === 'TYPING') {
        inputEl.placeholder = (currentLang === 'ko' ? "ì—¬ê¸°ì— êµ¬ì ˆì„ ë¹ ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”..." : "Type the holy verse quickly here...");

        inputEl.oninput = function() {
            if (this.value.trim() === prompt) {
                this.oninput = null;
                finishQTE(true);
            }
        };

    } else if (type === 'SPACEBAR') {
        var targetCount = 20;
        var currentCount = 0;
        inputEl.classList.add('hidden');
        document.getElementById('qte_prompt').innerText = (currentLang === 'ko' ? `[ìŠ¤í˜ì´ìŠ¤ë°” ì—°íƒ€!] ${prompt}: ${currentCount}/${targetCount}íšŒ` : `[Spacebar Mash!] ${prompt}: ${currentCount}/${targetCount} times`);

        var spaceHandler = function(e) {
            if (e.code === 'Space' || e.key === ' ') {
                e.preventDefault();
                currentCount++;
                document.getElementById('qte_prompt').innerText = (currentLang === 'ko' ? `[ìŠ¤í˜ì´ìŠ¤ë°” ì—°íƒ€!] ${prompt}: ${currentCount}/${targetCount}íšŒ` : `[Spacebar Mash!] ${prompt}: ${currentCount}/${targetCount} times`);

                if (currentCount >= targetCount) {
                    document.removeEventListener('keydown', spaceHandler);
                    finishQTE(true);
                }
            }
        };

        document.addEventListener('keydown', spaceHandler);
    }
}


document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('langSelect').addEventListener('change', function() {
        currentLang = this.value;
        go(state.currentPage);
    });

    document.getElementById('btnRnd').onclick = generateRandomScenario;

    // ìµœì¢… ì‹œì‘ ë²„íŠ¼ì€ ìœ„ì— ì •ì˜ëœ ìµëª… í•¨ìˆ˜ë¡œ ëŒ€ì²´ë˜ì—ˆìŠµë‹ˆë‹¤.

    go('p1');
});
      </script>
</body>
</html>